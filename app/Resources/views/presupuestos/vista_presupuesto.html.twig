{% extends 'base.html.twig' %}
{% block stylesheets %}
    {{ parent() }}

{% endblock %}
{% block body %}
    <div>
        <div class="row">
            <div class="col-md-12 prespuesto_container" >
                <div class="col-md-3 prespuesto_datos">
                    <div class="col-md-12 prespuesto_datos_numeros">
                        <fieldset>
                            <legend>Prespuesto</legend>
                            <div class="col-md-3">Número</div>
                            <div class="col-md-9"> {{ presupuesto[0].numero }}</div>
                            <div class="col-md-3">Fecha</div>
                            <div class="col-md-9"> {{ presupuesto[0].fecha| date('d/m/Y') }}</div>
                        </fieldset>
                    </div>
                    <div class="col-md-12" style="height: 30px"></div>
                    <div class="col-md-12 prespuesto_datos_cliente">
                        <fieldset>
                            <legend>
                                <span>Cliente</span>
                                <span id="clientesModalTrigger" class="glyphicon glyphicon-search pull-right"></span>
                            </legend>
                            <div class="col-md-12">
                                <div class="col-md-3">Código</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.codigo }}</div>
                                <div class="col-md-3">Nombre</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.nombre }}</div>
                                <div class="col-md-3">CIF</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.cif }}</div>
                                <div class="col-md-3">Dirección</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.direccion }}</div>
                                <div class="col-md-3">CP</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.codpost }}</div>
                                <div class="col-md-3">Municipio</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.poblacion }}</div>
                                <div class="col-md-3">Provincia</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.provincia }}</div>
                                <div class="col-md-3">Credito</div>
                                <div class="col-md-9"> {{ presupuesto[0].cliente.credito|trim|number_format(2, '.', ',') }}</div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-md-12" style="height: 30px"></div>
                    <div class="col-md-12 prespuesto_datos_numeros">
                        <fieldset>
                            <legend>Importes</legend>
                            <div class="col-md-12">
                                <div class="col-md-12">
                                    <div class="col-md-2"><span>Base:</span></div>
                                    <div class="total_importe_base col-md-6 col-md-offset-1"></div>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-2"><span>IVA:</span></div>
                                    <div class="total_importe_iva col-md-6 col-md-offset-1"></div>
                                </div>
                                <div class="col-md-12">
                                    <div class="col-md-2"><span>TOTAL:</span></div>
                                    <div class="total_importe col-md-6 col-md-offset-1"></div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-md-12" style="height: 30px"></div>
                    <div class="col-md-12 prespuesto_acciones_tabla">
                        <fieldset>
                            <legend>Acciones Tabla</legend>
                            <div class="col-md-3">
                                <button id="btn_nueva_linea" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-plus"></span> Nueva</button>
                            </div>
                            <div class="col-md-3">
                                <button id="btn_borrar_lineas" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove" ></span> Borrar</button>
                            </div>
                            <div class="col-md-3">
                                <button id="btn_insertar_articulo" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-plus" ></span> Articulo</button>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-md-12" style="height: 30px"></div>
                    <div class="col-md-12 prespuesto_acciones_db">
                        <fieldset>
                            <legend>Acciones Presupuesto</legend>
                            <div class="col-md-3">
                                <button class="btn btn-info btn-xs"><span class="glyphicon glyphicon-print"></span> Imprimir</button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove"></span> Enviar</button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info btn-xs"><span class="glyphicon glyphicon-floppy-save"></span> Guardar</button>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <div class="col-md-9" >
                    <table class="table table-bordered table-hover thead-inverse prespuesto_table">
                        <thead>
                            <tr>
                                <th>Artículo</th>
                                <th>Definición</th>
                                <th>Precio</th>
                                <th>Unidades</th>
                                {#<th>IVA</th>#}
                                <th>%</th>
                                <th>Importe</th>
                            </tr>
                        </thead>
                        <tbody class="table-striped">
                        {% for linea in detalles_presupuesto %}
                            {% set is_linea_articulo = false %}
                            {% if linea.articulo|trim != '' %}
                                {% set is_linea_articulo = true %}
                            {% endif %}

                                {% if linea.articulo|trim != '' %}
                                    <tr class="table_row_head" onclick="toggleTableRowActive(this)">
                                        <td><div class="input_row_articulo">{{ linea.articulo|trim }}</div></td>
                                        <td><div class="input_row_definicion"><input type="text" value="{{ linea.definicion|trim }}" maxlength="75"></div></td>
                                        <td><div class="input_row_precio"><input type="text" value="{{ linea.precio|trim|number_format(2, '.', '') }}"></div></td>
                                        <td><div class="input_row_unidades"><input type="text" value="{{ linea.unidades|trim|number_format(2, '.', '') }}" ></div></td>
                                        {#<td><div class="input_row_iva"><input type="text" value="{{ linea.tipoiva|trim }}" ></div></td>#}
                                        <td><div class="input_row_dto"><input type="text" value="{{ linea.dto1|trim }}" ></div></td>
                                        <td><div class="input_row_importe">{{ linea.importe|trim|number_format(2, '.', '') }}</div></td>
                                {% else %}
                                    <tr class="table_row_body" onclick="toggleTableRowActive(this)">
                                        <td></td>
                                        <td><div class="input_row_definicion"><input type="text" value="{{ linea.definicion|trim }}" maxlength="75"></div></td>
                                        <td></td>
                                        <td></td>
                                        {#<td></td>#}
                                        <td></td>
                                        <td></td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="clientesModal" class="modal fade" role="dialog">
        <div class="modal-dialog" role="document">
            <!-- Modal Content-->
            <div class="modal-content">
                <div class="modal-header">

                        <div class="pull-left"><h4 class="modal-title">Clientes</h4></div>
                        <div class="pull-right">
                            <input type="text" onkeyup="filter(this)" name="search" id="search" placeholder="Filtro"
                                   class="pull-right"/>
                        </div>

                </div>
                <div class="modal-body">
                    <div class="form-group">
                    {% for cliente in clientes %}
                        <div class="row client_row">
                            <div class="col-md-2">{{ cliente.codigo }}</div>
                            <div class="col-md-10">{{ cliente.nombre }}</div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="articulosModal" class="modal fade" role="dialog">
    <div class="modal-dialog" role="document" style="width: 80%">
        <!-- Modal Content-->
        <div class="modal-content">
            <div class="modal-header">

                <div class="pull-left">
                    <h4 class="modal-title">Articulos</h4>
                </div>
                <div class="form-group col-md-3 col-md-offset-2">
                    <label for="familia_selector">Familia</label>
                    <select class="form-control" id="familia_selector">
                        {#<option value="" disabled selected>Familia</option>#}
                        <option value="">All</option>
                        <option value="03">03</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="marca_selector">Marca</label>
                    <select class="form-control" id="marca_selector">
                        {#<option value="" disabled selected>Marca</option>#}
                        <option value="">All</option>
                        <option value="01">01</option>
                        <option value="04">04</option>
                        <option value="11">11</option>
                    </select>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="row" style="color: white; background: black; font-size: 1.2em">
                        <div class="col-md-2">Código</div>
                        <div class="col-md-2">Familia</div>
                        <div class="col-md-2">Marca</div>
                        <div class="col-md-5">Nombre</div>
                        <div class="col-md-1">Precio</div>
                    </div>
                    {% for articulo in articulos %}
                        <div class="row article_row" data-codigo="{{ articulo.codigo|trim|url_encode }}">
                            <div class="col-md-2">{{ articulo.codigo|trim }}</div>
                            <div class="col-md-2 familia_column">{{ articulo.familia }}</div>
                            <div class="col-md-2 marca_column">{{ articulo.marca }}</div>
                            <div class="col-md-5">{{ articulo.nombre }}</div>
                            <div class="col-md-1">{{ articulo.pmcom1|trim|number_format(2, '.', '') }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    </div>

{% endblock %}
{% block javascripts %}
    {{ parent() }}

    <script >
        $(document).ready(function(){

            // UPDATE IMPORT ROWS
            $('.table_row_head').on('change', function() {
                var precio = parseFloat($(this).find(".input_row_precio :input").val());
                var unidades = parseFloat($(this).find(".input_row_unidades :input").val());
//                var iva = parseFloat($(this).find(".input_row_iva :input").val());
                var dto = parseFloat($(this).find(".input_row_dto :input").val());

                var base =  ( precio * unidades );
//                var importe_iva = ( base * iva ) / 100;
//                var importe = base + importe_iva;
                var importe = base;

                var importe_descuento = ( importe * dto ) / 100;
                importe = importe - importe_descuento;

                $(this).find(".input_row_importe").html(importe.toFixed(2));

                calc_importe_total();

            });

            $('#clientesModalTrigger').click(function() {
                $('#clientesModal').modal();
            });

            $('#btn_borrar_lineas').on('click', function() {

                var $set = $('tr.active');
                var len = $set.length;

                if (len > 0) {
                    $set.each(function () {
                        this.remove();
                    });
                } else {
                  alert("No hay Lineas Seleccionadas");
                }

            });


            $('#btn_nueva_linea').on('click', function() {

                var line = get_line_for_inserting();

                line.after(
                        '<tr class="tabel_row_body active" onclick="toggleTableRowActive(this)">' +
                        '<td>&nbsp;</td>' +
                        '<td><div class="input_row_definicion"><input type="text" value="" maxlength="75"></div></td>' +
                        '<td></td>' +
                        '<td></td>' +
//                        '<td></td>' +
                        '<td></td>' +
                        '<td></td>' +
                        '</tr>'
                );

            });

            $('#btn_insertar_articulo').on('click', function() {
                $('#articulosModal').modal();
            });


            $('.article_row').on('click', function() {

                var codigo = this.dataset.codigo;
                var url =  "/api/articulos/" + codigo;
                console.log(url);

                $.ajax({
                    url: url,
                    success: function(result){

                        var data = result['articulo'][0];
                        console.log(data);
                        var line = get_line_for_inserting();

                        line.after(
                                '<tr class="table_row_head active" onclick="toggleTableRowActive(this)">' +
                                    '<td><div class="input_row_articulo">' + data['codigo'] + '</div></td>' +
                                    '<td><div class="input_row_definicion"><input type="text" value="' + data['nombre'] + '" maxlength="75"></div></td>' +
                                    '<td><div class="input_row_precio"><input type="text" value="' + data['precio'] + '"></div></td>' +
                                    '<td><div class="input_row_unidades"><input type="text" value="0.00"></div></td>' +
//                                    '<td><div class="input_row_iva"><input type="text" value="' + data['tipo_iva'] + '"></div></td>' +
                                    '<td><div class="input_row_dto"><input type="text" value="0" ></div></td>' +
                                    '<td><div class="input_row_importe">' + data['precio'] + '</div></td>' +
                                '</tr>'
                        );

                        data['definicion'].forEach( function (row) {

                            line = get_line_for_inserting();

                            line.after(
                                    '<tr class="table_row_body active" onclick="toggleTableRowActive(this)">' +
                                    '<td>&nbsp;</td>' +
                                    '<td><div class="input_row_definicion"><input type="text" value="' + row + '" maxlength="75"></div></td>' +
                                    '<td></td>' +
                                    '<td></td>' +
//                                    '<td></td>' +
                                    '<td></td>' +
                                    '<td></td>' +
                                    '</tr>'
                            );

                        });

                       $('#articulosModal').modal('hide');

                }});

            });

            $('#familia_selector').on('change', function() {

                var value = $(this).val();

                $(".article_row").each(function () {
                    text = $(this).find('.familia_column')
                            .text()
                            .replace(/(\r\n|\n|\r)/gm, "")
                            .toString()
                            .trim()
                            .toUpperCase();

                    if (text.search(value) > -1) {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }
                });
            });

            $('#marca_selector').on('change', function() {

                var value = $(this).val();

                $(".article_row").each(function () {
                    text = $(this).find('.marca_column')
                            .text()
                            .replace(/(\r\n|\n|\r)/gm, "")
                            .toString()
                            .trim()
                            .toUpperCase();

                    if (text.search(value) > -1) {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }
                });
            });

            calc_importe_total();
        });
    </script>

    <script>
        function calc_importe_total () {
            var total_importe = 0;
            $('.input_row_importe').each( function(index, element) {
                total_importe = total_importe + parseFloat($(element).text());
            });

            $('.total_importe').html(total_importe.toFixed(2));
        }
    </script>

    <script>
        function selectCliente (codigo) {
            console.log(codigo);
        }

        function get_line_for_inserting() {
            var $set = $('tr.active');
            var len = $set.length;
            var target = null;

            if (len > 0) {
                $set.each(function(index, element) {
                    if (index == len - 1) {
                        target = $(this);
                    }
                });
            } else {
                target = $('.prespuesto_table tr:last');
                $('html, body').animate({
                    scrollTop: target.offset().top
                }, 1000);
            }

            return target;
        }
    </script>

    <script>
        function toggleTableRowActive(row) {
            if ($(row).hasClass("active")) {
                $(row).removeClass("active")
            } else {
                $(row).addClass("active")
            }
        }
    </script>

    <script language="javascript" type="text/javascript">
        function filter(element) {

            var count = 0;
            var value = $(element).val();
            value = value.toUpperCase();

            $(".client_row").each(function () {
                text = $(this)
                        .text()
                        .replace(/(\r\n|\n|\r)/gm, "")
                        .toString()
                        .trim()
                        .toUpperCase();
                if (text.search(value) > -1) {
                    $(this).show();
                    count++;
                    $("input[name='list_matched']").show();
                }
                else {
                    $(this).hide();
                }
            });

        }
    </script>
{% endblock %}